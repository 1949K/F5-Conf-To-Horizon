{% extends "base.html" %}

{% block title %}F5 Show 配置翻译{% endblock %}

{% block extra_css %}
<style>
    /* 统一按钮样式 */
    .download-btn {
        border-radius: 20px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    /* 文件上传区域样式 */
    .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        text-align: center;
        transition: all 0.3s ease;
    }

    .file-upload-area.dragover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }

    /* 状态圆点样式 */
    .status-dots {
        display: flex;
        gap: 6px;
        margin-left: auto;
    }

    .dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        display: inline-block;
        border: 2px solid #ddd;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .dot:hover {
        transform: scale(1.2);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .txt-dot {
        background-color: transparent;
        border-color: #000;
    }

    .conf-dot {
        background-color: transparent;
        border-color: #000;
    }

    .log-dot {
        background-color: transparent;
        border-color: #000;
    }

    .processed-dot {
        background-color: transparent;
        border-color: #000;
    }

    .excel-dot {
        background-color: transparent;
        border-color: #000;
    }

    .log-output-dot {
        background-color: transparent;
        border-color: #000;
    }

    .txt-dot.active {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .conf-dot.active {
        background-color: #198754;
        border-color: #198754;
    }

    .log-dot.active {
        background-color: #ffc107;
        border-color: #ffc107;
    }

    .processed-dot.active {
        background-color: #6f42c1;
        border-color: #6f42c1;
    }

    .excel-dot.active {
        background-color: #20c997;
        border-color: #20c997;
    }

    .log-output-dot.active {
        background-color: #fd7e14;
        border-color: #fd7e14;
    }

    /* 表格优化样式 */
    .status-matrix-table {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        max-height: none !important;
        overflow: visible !important;
    }

    .status-matrix-table th {
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }

    .status-matrix-table td {
        vertical-align: middle;
        padding: 0.75rem 0.5rem;
    }

    /* 表格行交替颜色 */
    .status-matrix-table tbody tr:nth-child(even) {
        background-color: #f8f9fa;
    }

    .status-matrix-table tbody tr:nth-child(odd) {
        background-color: #ffffff;
    }

    .status-matrix-table tbody tr:hover {
        background-color: #e9ecef;
        transition: background-color 0.2s ease;
    }

    /* 下载行的悬停效果 */
    .status-matrix-table tbody tr td[onclick]:hover {
        background-color: #e9ecef !important;
        color: #0d6efd !important;
        font-weight: bold;
        transition: all 0.2s ease;
    }

    /* 日志区域样式 */
    .log-area {
        max-height: 300px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }

    .log-item {
        margin-bottom: 4px;
        padding: 2px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card" style="height: 400px; overflow-y: auto;">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-eye me-2"></i>F5 Show 配置翻译
                </h4>
            </div>
            <div class="card-body" style="height: calc(320px - 60px);">
                <!-- 文件上传区域 -->
                <div class="file-upload-area" id="uploadArea" 
                     style="padding: 60px;height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column;">
                    <i class="fas fa-cloud-upload-alt fa-2x text-success mb-2"></i>
                    <h6>拖拽文件到此处或点击选择文件</h6>
                    <p class="text-muted small mb-2">支持的文件格式：TXT、CONF</p>
                    <input type="file" id="fileInput" multiple accept=".txt,.conf" style="display: none;">
                    <button class="btn btn-success btn-sm download-btn btn-auto" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open me-2"></i>选择文件
                    </button>
                </div>
            </div>

            <div class="card-body">
                <div class="row mb-3 justify-content-center">
                    <div class="col-3">
                        <button class="btn btn-warning download-btn btn-full" onclick="reExecuteTranslationProcess()">
                            <i class="fas fa-redo me-2"></i>重新执行翻译
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-danger download-btn btn-full" onclick="deleteAllFiles()">
                            <i class="fas fa-trash me-2"></i>删除全部文件
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-primary download-btn btn-full" onclick="downloadTranslationResults('all')">
                            <i class="fas fa-file-archive me-2"></i>下载翻译结果
                        </button>
                    </div>
                    <div class="col-3">
                        <button class="btn btn-success download-btn btn-full" onclick="downloadAllFilesComplete()">
                            <i class="fas fa-download me-2"></i>下载全部文件
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- 状态和日志 -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-terminal me-2"></i>处理日志
                </h5>
            </div>
            <div class="card-body">
                <div id="logArea" class="log-area">
                    <div class="text-muted">等待操作...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 状态矩阵表格 -->
    <div class="mt-4" id="statusMatrixSection">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>整体流程</h5>
            </div>
            <div class="card-body p-0">
                <div id="statusMatrixTable" class="table-responsive" style="max-height: none; overflow: visible;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const logArea = document.getElementById('logArea');

        // 清空日志
        function clearLog() {
            logArea.innerHTML = '<div class="text-muted">等待操作...</div>';
        }

        // 拖拽上传处理
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            
            // 检查文件类型
            const validFiles = files.filter(file => {
                const ext = file.name.toLowerCase().split('.').pop();
                if (ext === 'txt' || ext === 'conf') {
                    return true;
                } else {
                    addLog(`不支持的文件类型: ${file.name}，请上传TXT或CONF文件`, 'error');
                    return false;
                }
            });
            
            if (validFiles.length > 0) {
                clearLog(); // 清空之前的日志
                validFiles.forEach(uploadFile);
            }
        });

        // 文件选择处理
        fileInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            
            // 检查文件类型
            const validFiles = files.filter(file => {
                const ext = file.name.toLowerCase().split('.').pop();
                if (ext === 'txt' || ext === 'conf') {
                    return true;
                } else {
                    addLog(`不支持的文件类型: ${file.name}，请上传TXT或CONF文件`, 'error');
                    return false;
                }
            });
            
            if (validFiles.length > 0) {
                clearLog(); // 清空之前的日志
                validFiles.forEach(uploadFile);
            }
            fileInput.value = ''; // 清空选择，允许重复选择相同文件
        });

        // 上传文件处理
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            // 发送上传请求
            fetch('/upload/show', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(`文件 ${file.name} 上传成功`, 'success');
                    // 刷新状态矩阵
                    setTimeout(() => loadStatusMatrix(), 500);
                } else {
                    addLog(`文件 ${file.name} 上传失败: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLog(`文件 ${file.name} 上传失败: ${error}`, 'error');
            });
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logItem = document.createElement('div');
            logItem.className = `log-item text-${type}`;
            logItem.innerHTML = `
                <small class="text-muted">[${timestamp}]</small>
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-1"></i>
                ${message}
            `;
            
            // 如果是第一条日志，清除"等待操作..."
            if (logArea.querySelector('.text-muted')) {
                logArea.innerHTML = '';
            }
            
            logArea.appendChild(logItem);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // 处理文件
        window.processFiles = function(action) {
            addLog(`开始${getActionName(action)}...`);
            
            const formData = new FormData();
            formData.append('file_type', 'show');
            
            fetch(`/process/${action}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(`${getActionName(action)}完成`, 'success');
                    // 刷新状态矩阵
                    setTimeout(() => loadStatusMatrix(), 500);
                } else {
                    addLog(`${getActionName(action)}失败: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLog(`${getActionName(action)}失败: ${error}`, 'error');
            });
        };

        // 获取操作名称
        function getActionName(action) {
            const actionNames = {
                'txt_to_log': 'TXT转LOG',
                'show_conf_to_excel_txt': 'Show Conf转换',
                'show_base_to_excel_txt': 'Show Base转换'
            };
            return actionNames[action] || action;
        }

        // 加载状态矩阵
        function loadStatusMatrix() {
            fetch('/show_status_matrix')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        renderStatusMatrix(data.matrix);
                    } else {
                        document.getElementById('statusMatrixTable').innerHTML = '<div class="text-danger p-3">加载流程状态失败</div>';
                    }
                })
                .catch(error => {
                    document.getElementById('statusMatrixTable').innerHTML = '<div class="text-danger p-3">加载流程状态失败: ' + error + '</div>';
                });
        }

        function renderStatusMatrix(matrix) {
            const tableDiv = document.getElementById('statusMatrixTable');
            let html = '<table class="table table-bordered table-sm align-middle mb-0 status-matrix-table" style="border: 2px solid #dee2e6;"><thead>' +
                '<tr class="table-light">' +
                '<th class="text-center align-middle bg-light" style="min-width: 200px;">文件处理流程</th>' +
                '<th class="text-center bg-light align-middle">TXT</th>' +
                '<th class="text-center bg-light align-middle">CONF</th>' +
                '<th class="text-center bg-light align-middle">LOG</th>' +
                '<th class="text-center bg-light align-middle">已处理</th>' +
                '<th class="text-center bg-light align-middle">Excel</th>' +
                '<th class="text-center bg-light align-middle">LOG输出</th>' +
                '</tr></thead><tbody>';
            
            const keys = Object.keys(matrix).sort();
            
            if (keys.length === 0) {
                html += '<tr><td colspan="7" class="text-muted text-center py-4"><i class="fas fa-inbox me-2"></i>暂无文件</td></tr>';
            } else {
                keys.forEach((base, index) => {
                    const row = matrix[base];
                    const rowClass = index % 2 === 0 ? 'table-light' : '';
                    html += `<tr class="${rowClass}">` +
                        `<td class="fw-bold text-dark bg-light">${base}</td>` +
                        `<td class="text-center align-middle"><span class="dot txt-dot${row.txt ? ' active' : ''}" title="${row.txt ? 'TXT文件已上传' : 'TXT文件未上传'}"></span></td>` +
                        `<td class="text-center align-middle"><span class="dot conf-dot${row.conf ? ' active' : ''}" title="${row.conf ? 'CONF文件已上传' : 'CONF文件未上传'}"></span></td>` +
                        `<td class="text-center align-middle"><span class="dot log-dot${row.log ? ' active' : ''}" title="${row.log ? 'LOG文件已生成' : 'LOG文件未生成'}"></span></td>` +
                        `<td class="text-center align-middle"><span class="dot processed-dot${row.processed ? ' active' : ''}" title="${row.processed ? '文件已处理' : '文件未处理'}"></span></td>` +
                        `<td class="text-center align-middle"><span class="dot excel-dot${row.excel ? ' active' : ''}" title="${row.excel ? 'Excel文件已生成' : 'Excel文件未生成'}"></span></td>` +
                        `<td class="text-center align-middle"><span class="dot log-output-dot${row.log_output ? ' active' : ''}" title="${row.log_output ? 'LOG输出已生成' : 'LOG输出未生成'}"></span></td>` +
                        '</tr>';
                });

                // 添加全部下载行
                const hasAnyFilesOverall = keys.some(base => {
                    const row = matrix[base];
                    return row.txt || row.conf || row.log || row.processed || row.excel || row.log_output;
                });

                if (hasAnyFilesOverall) {
                    html += '<tr class="table-light">' +
                        '<td class="fw-bold text-dark text-center">下载</td>' +
                        '<td colspan="2" class="text-center align-middle fw-bold" style="cursor: pointer;" onclick="downloadByGroup(\'input\')" title="点击下载所有输入文件（TXT和CONF）">输入文件</td>' +
                        '<td class="text-center align-middle fw-bold" style="cursor: pointer;" onclick="downloadByGroup(\'log\')" title="点击下载所有LOG文件">LOG文件</td>' +
                        '<td class="text-center align-middle fw-bold" style="cursor: pointer;" onclick="downloadByGroup(\'processed\')" title="点击下载所有已处理文件">已处理</td>' +
                        '<td colspan="2" class="text-center align-middle fw-bold" style="cursor: pointer;" onclick="downloadByGroup(\'output\')" title="点击下载所有输出文件（Excel和LOG输出）">输出文件</td>' +
                        '</tr>';
                }
            }
            html += '</tbody></table>';
            tableDiv.innerHTML = html;
        }

        // 按组下载文件
        window.downloadByGroup = function(groupType) {
            const groupNames = {
                'input': '输入文件（TXT和CONF）',
                'log': 'LOG文件',
                'processed': '已处理文件',
                'output': '输出文件（Excel和LOG输出）'
            };

            addLog(`开始下载所有${groupNames[groupType]}...`);

            // 创建一个隐藏的下载链接
            const downloadLink = document.createElement('a');
            downloadLink.href = `/download_by_group/show/${groupType}`;
            downloadLink.download = `${groupType}_files.tar`;
            downloadLink.style.display = 'none';

            // 添加到页面并触发下载
            document.body.appendChild(downloadLink);
            downloadLink.click();

            // 清理
            document.body.removeChild(downloadLink);

            addLog(`${groupNames[groupType]}下载已开始`, 'success');
        };

        // 重新执行翻译流程
        window.reExecuteTranslationProcess = function () {
            addLog('开始重新执行翻译流程...', 'info');
            fetch('/show_status_matrix')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const matrix = data.matrix;
                        const keys = Object.keys(matrix);
                        if (keys.length === 0) {
                            addLog('没有找到任何文件，请先上传文件', 'error');
                            return;
                        }
                        addLog(`找到 ${keys.length} 个文件，开始分析处理状态...`, 'info');
                        let processedCount = 0;
                        let totalFiles = keys.length;
                        keys.forEach((base, index) => {
                            const row = matrix[base];
                            setTimeout(() => {
                                executeProcessForFile(base, row, () => {
                                    processedCount++;
                                    if (processedCount === totalFiles) {
                                        addLog('所有文件的翻译流程重新执行完成', 'success');
                                        setTimeout(() => loadStatusMatrix(), 1000);
                                    }
                                }, () => {
                                    processedCount++;
                                    if (processedCount === totalFiles) {
                                        addLog('所有文件的翻译流程重新执行完成', 'success');
                                        setTimeout(() => loadStatusMatrix(), 1000);
                                    }
                                });
                            }, index * 500);
                        });
                    } else {
                        addLog('获取状态矩阵失败', 'error');
                    }
                })
                .catch(error => {
                    addLog(`重新执行翻译流程失败: ${error}`, 'error');
                });
        };

        function executeProcessForFile(base, row, callback, failCallback) {
            addLog(`分析文件 ${base} 的处理状态...`, 'info');
            let processSteps = [];
            if (row.txt && !row.log) {
                processSteps.push('txt_to_log');
                addLog(`文件 ${base}: 需要TXT转LOG`, 'info');
            }
            if ((row.conf || row.base) && (!row.excel)) {
                processSteps.push('show_conf_to_excel_txt');
                addLog(`文件 ${base}: 需要conf转Excel/TXT`, 'info');
            }
            if ((row.conf || row.base) && (!row.log_output)) {
                processSteps.push('show_base_to_excel_txt');
                addLog(`文件 ${base}: 需要base转Excel/TXT`, 'info');
            }
            if (processSteps.length === 0) {
                addLog(`文件 ${base}: 所有流程已完成，无需重新执行`, 'success');
                callback();
                return;
            }
            addLog(`文件 ${base}: 需要执行 ${processSteps.length} 个步骤`, 'info');
            executeProcessSteps(processSteps, 0, callback, failCallback);
        }

        function executeProcessSteps(steps, index, callback, failCallback) {
            if (index >= steps.length) {
                callback();
                return;
            }
            const step = steps[index];
            addLog(`执行步骤: ${getActionName(step)}`, 'info');
            fetch(`/process/${step}`, {
                method: 'POST',
                body: (() => { let fd = new FormData(); fd.append('file_type', 'show'); return fd; })()
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLog(`${getActionName(step)}完成`, 'success');
                        setTimeout(() => executeProcessSteps(steps, index + 1, callback, failCallback), 2000);
                    } else {
                        addLog(`${getActionName(step)}失败: ${data.error}`, 'error');
                        if (failCallback) failCallback();
                    }
                })
                .catch(error => {
                    addLog(`${getActionName(step)}失败: ${error}`, 'error');
                    if (failCallback) failCallback();
                });
        }

        // 下载全部文件
        window.downloadAllFilesComplete = function () {
            addLog('开始下载所有文件...');
            fetch('/download_all_files/show')
                .then(response => {
                    if (response.status === 404) {
                        addLog('没有找到任何文件，请先上传文件', 'error');
                        throw new Error('没有文件');
                    }
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(data => {
                            if (data.error) {
                                addLog('没有找到任何文件，请先上传文件', 'error');
                                throw new Error(data.error);
                            }
                            throw new Error('未知错误');
                        });
                    }
                    return response.blob();
                })
                .then(blob => {
                    const downloadLink = document.createElement('a');
                    const url = window.URL.createObjectURL(blob);
                    downloadLink.href = url;
                    downloadLink.download = 'all_files.tar';
                    downloadLink.style.display = 'none';
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    window.URL.revokeObjectURL(url);
                    addLog('所有文件下载已开始', 'success');
                })
                .catch(err => {
                    // 已在上面 addLog 过，无需重复
                });
        };

        // 下载所有翻译结果
        window.downloadTranslationResults = function (type = 'all') {
            const typeNames = {
                'excel': 'Excel翻译结果',
                'txt': 'TXT翻译结果',
                'all': '所有翻译结果'
            };
            addLog(`开始下载${typeNames[type]}...`);
            fetch(`/download_translation_results/show/${type}`)
                .then(response => {
                    if (response.status === 404) {
                        addLog('没有找到任何文件，请先上传文件', 'error');
                        throw new Error('没有文件');
                    }
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json().then(data => {
                            if (data.error) {
                                addLog('没有找到任何文件，请先上传文件', 'error');
                                throw new Error(data.error);
                            }
                            throw new Error('未知错误');
                        });
                    }
                    return response.blob();
                })
                .then(blob => {
                    const downloadLink = document.createElement('a');
                    const url = window.URL.createObjectURL(blob);
                    downloadLink.href = url;
                    downloadLink.download = `translation_results_${type}.tar`;
                    downloadLink.style.display = 'none';
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    window.URL.revokeObjectURL(url);
                    addLog(`${typeNames[type]}下载已开始`, 'success');
                })
                .catch(err => {
                    // 已在上面 addLog 过，无需重复
                });
        };

        // 删除全部文件
        window.deleteAllFiles = function () {
            if (!confirm('确定要删除所有相关文件吗？此操作不可恢复！')) {
                return;
            }

            addLog('开始删除所有相关文件...');

            fetch('/delete_all_files/show', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLog('所有文件已成功从服务器删除', 'success');
                        // 刷新状态矩阵
                        setTimeout(() => loadStatusMatrix(), 500);
                    } else {
                        addLog(`删除失败: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    addLog(`删除失败: ${error}`, 'error');
                });
        };

        // 页面加载时获取状态矩阵
        loadStatusMatrix();
    });
</script>
{% endblock %} 